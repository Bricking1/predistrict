import { useState, useEffect } from 'react';

export default function Home() {
  const [wallet, setWallet] = useState(null);
  const [points, setPoints] = useState(0);
  const [subscribed, setSubscribed] = useState(false);
  const [ranking, setRanking] = useState([]);
  const [tip, setTip] = useState('');

  useEffect(() => {
    if (wallet) {
      checkSubscription(wallet);
      fetchRanking();
      fetchPoints(wallet);
    }
  }, [wallet]);

  async function connectWallet() {
    if (!window.ethereum) {
      alert('MetaMask is required to connect wallet');
      return;
    }
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    setWallet(accounts[0]);
  }

  async function checkSubscription(addr) {
    const res = await fetch('/api/check-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ walletAddress: addr }),
    });
    const data = await res.json();
    setSubscribed(data.subscribed);
  }

  async function fetchRanking() {
    const res = await fetch('/api/ranking');
    const data = await res.json();
    setRanking(data.ranking || []);
  }

  async function fetchPoints(addr) {
    const res = await fetch(`/api/user-points?walletAddress=${addr}`);
    const data = await res.json();
    setPoints(data.points || 0);
  }

  async function submitTip() {
    if (!tip) {
      alert('Please enter your tip');
      return;
    }
    const res = await fetch('/api/submit-tip', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ walletAddress: wallet, tip }),
    });
    const data = await res.json();
    alert(data.message);
    setPoints(data.points);
    fetchRanking();
    setTip('');
  }

  return (
    <div style={{ padding: '20px', fontFamily: 'Arial, sans-serif' }}>
      <h1>Predistrict</h1>
      {!wallet ? (
        <button onClick={connectWallet}>Connect Wallet</button>
      ) : (
        <>
          <p><b>Wallet:</b> {wallet}</p>
          <p><b>Points:</b> {points}</p>
          <p><b>Subscription status:</b> {subscribed ? 'Active' : 'Inactive'}</p>

          <h3>Today's Question: Will it rain today in Budapest?</h3>

          <input
            type="text"
            placeholder="Your tip (yes/no)"
            value={tip}
            onChange={e => setTip(e.target.value)}
          />
          <button onClick={submitTip} disabled={!subscribed}>Submit Tip</button>

          {!subscribed && <p style={{ color: 'red' }}>You must have an active subscription to submit tips.</p>}

          <h3>Ranking (Top 25)</h3>
          <ol>
            {ranking.map(user => (
              <li key={user.walletAddress}>
                {user.walletAddress.substring(0, 6)}... - {user.points} points
              </li>
            ))}
          </ol>
        </>
      )}
    </div>
  );
}
