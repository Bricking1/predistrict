const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const mongoose = require('mongoose');

const app = express();
app.use(cors());
app.use(bodyParser.json());

mongoose.connect('mongodb+srv://<username>:<password>@cluster0.mongodb.net/predistrict?retryWrites=true&w=majority', {
  useNewUrlParser: true,
  useUnifiedTopology: true,
});

// --- Schemas ---

const userSchema = new mongoose.Schema({
  walletAddress: { type: String, unique: true, required: true },
  points: { type: Number, default: 0 },
  packages: [
    {
      type: String, // 'emergency', 'weekly_15', 'weekly_25'
      validUntil: Date,
    }
  ],
  createdAt: { type: Date, default: Date.now },
});

const tipSchema = new mongoose.Schema({
  walletAddress: String,
  date: Date,
  tip: String,
  correct: Boolean,
  pointsChange: Number,
});

const User = mongoose.model('User', userSchema);
const Tip = mongoose.model('Tip', tipSchema);

// --- Helpers ---

function getPackageDuration(packageType) {
  const now = new Date();
  if (packageType === 'emergency') {
    now.setMonth(now.getMonth() + 1);
  } else if (packageType === 'weekly_15' || packageType === 'weekly_25') {
    now.setDate(now.getDate() + 7);
  }
  return now;
}

function calculatePointsChange(isCorrect) {
  return isCorrect ? 50 : -20;
}

// --- API ---

// Register or update user
app.post('/api/register', async (req, res) => {
  const { walletAddress } = req.body;
  if (!walletAddress) return res.status(400).json({ error: 'Wallet address required' });

  let user = await User.findOne({ walletAddress });
  if (!user) {
    user = new User({ walletAddress });
    await user.save();
  }
  res.json({ message: 'User registered', user });
});

// Check subscription status
app.post('/api/check-subscription', async (req, res) => {
  const { walletAddress } = req.body;
  if (!walletAddress) return res.status(400).json({ error: 'Wallet address required' });

  const user = await User.findOne({ walletAddress });
  if (!user) return res.json({ subscribed: false });

  const now = new Date();
  const hasValidPackage = user.packages.some(pkg => pkg.validUntil > now);
  res.json({ subscribed: hasValidPackage });
});

// Buy package (mock payment)
app.post('/api/buy-package', async (req, res) => {
  const { walletAddress, packageType } = req.body;
  if (!walletAddress || !packageType) return res.status(400).json({ error: 'Missing walletAddress or packageType' });

  const user = await User.findOne({ walletAddress });
  if (!user) return res.status(404).json({ error: 'User not found' });

  const validUntil = getPackageDuration(packageType);
  user.packages.push({ type: packageType, validUntil });
  await user.save();

  res.json({ message: 'Package purchased', validUntil });
});

// Submit tip
app.post('/api/submit-tip', async (req, res) => {
  const { walletAddress, tip } = req.body;
  if (!walletAddress || !tip) return res.status(400).json({ error: 'Missing walletAddress or tip' });

  const user = await User.findOne({ walletAddress });
  if (!user) return res.status(404).json({ error: 'User not found' });

  // Simulate tip correctness (replace with real logic)
  const correct = Math.random() > 0.5;
  const pointsChange = calculatePointsChange(correct);

  user.points = Math.max(0, user.points + pointsChange);
  await user.save();

  const newTip = new Tip({
    walletAddress,
    date: new Date(),
    tip,
    correct,
    pointsChange,
  });
  await newTip.save();

  res.json({ message: correct ? 'Correct tip! +50 points' : 'Wrong tip! -20 points', points: user.points });
});

// Get ranking (top 25, min 10 players)
app.get('/api/ranking', async (req, res) => {
  const count = await User.countDocuments();
  if (count < 10) return res.json({ message: 'Not enough players for ranking', ranking: [] });

  const users = await User.find().sort({ points: -1 }).limit(25);
  const ranking = users.map(u => ({ walletAddress: u.walletAddress, points: u.points }));
  res.json({ ranking });
});

// Get user points (optional)
app.get('/api/user-points', async (req, res) => {
  const { walletAddress } = req.query;
  if (!walletAddress) return res.status(400).json({ error: 'walletAddress required' });

  const user = await User.findOne({ walletAddress });
  if (!user) return res.json({ points: 0 });
  res.json({ points: user.points });
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, () => console.log(`Predistrict backend running on port ${PORT}`));
